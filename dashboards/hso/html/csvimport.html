<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<script src="https://cdn.plot.ly/plotly-3.3.0.min.js" charset="utf-8"></script>
<script type="text/javascript"
	src="../../../src/js/water/structures/WaterLevelCsvReader.js" charset="utf-8"></script>
<title>Read CSV File</title>
<style>
.line {
	display: flex;
	flex-direction: row;
}

.value {
	margin-right: 5px;
	background: red;
	width: 150px;
}

.value:first-child {
	width: 200px;
}
</style>
</head>
<body>
	<div>
	<label>Start Date</label>
	<input type="date" id="startDate"  name="Series start date" value="2021-03-21"/>
	<label>End Date</label>
	<input type="date" id="endDate"  name="Series end date" value="2021-03-28"/>
	<label>Weir name: </label>
	<input type='text' id="nameField" value=  "WS000278"/>
	</div>
	<div><input type="file" id="fileInput" accept=".csv" /></div>
	
	<p id="filefeedback" />
	<pre id="output"></pre>

	<script>
		function getWaterLevelTraces(results) {
			let traces = [];

			if (results == null || results.length < 2) {
				return traces;
			}

			let headers = results[0];
			let attributes = results[1];
			for (let i = 0; i < headers.length && i < attributes.length; i++) {
				if (headers[i] == null || headers[i].length == 0
						|| headers[i].endsWith("quality")) {
					continue;
				}

				let trace = {
					x : [],
					y : [],
					mode : 'lines+markers',
					name : headers[i] + " " + attributes[i]
				};
				traces.push(trace);

				for (let r = 0; r < results.length; r++) {
					if (results[r][i + 1] == "original reliable") {
						trace.x.push(new Date(results[r][0]));

						let value = parseFloat(results[r][i].replace(",", "."));
						trace.y.push(value);
					}
				}

			}
			return traces;
		}

		function plotResults(reader) {

			let traces = getWaterLevelTraces(reader.getResults());

			let layout = {
				title : {
					text : 'Data values'
				}
			};

			Plotly.newPlot('output', traces, layout);
		}

		let validNames = document.getElementById("nameField").value.split(",");
		function isValidHeader(header) {
			if (header == null || header.endsWith("comments")) {
				return false;
			}

			let names = validNames;
			for(name of names){
				if(header.startsWith(name)){
					return true;
				}
			}
			return false;
		}

		
		const reader = new WaterLevelCSVReader();
		reader.setHeaderPredicate(isValidHeader);
		reader.setOnFinish(plotResults);

		document.getElementById('fileInput').addEventListener('change',
				function(event) {
					validNames = document.getElementById("nameField").value.split(",");
					const file = event.target.files[0];
					if (file) {
						
						const startDate = new Date(document.getElementById('startDate').value);
						const endDate = new Date(document.getElementById('endDate').value);
						reader.setStartDate(startDate);
						reader.setEndDate(endDate);
					
						reader.readFromFile(file);
					}
				});
	</script>
</body>
</html>