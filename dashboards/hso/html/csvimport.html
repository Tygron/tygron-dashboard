<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Read CSV File</title>
<style>
.line {
	display: flex;
	flex-direction: row;
}

.value {
	margin-right: 5px;
	background: red;
	width: 150px;
}

.value:first-child {
	width: 200px;
}
</style>
</head>
<body>
	<input type="file" id="fileInput" accept=".csv" />
	<p id="filefeedback" />
	<pre id="output"></pre>

	<script>
	const startDate = new Date("2020-03-21");
	const endDate = new Date("2020-03-28");
	const predicate = function(s){ return s== null || s.endsWith("comments")? false : s.startsWith("WS000278")};
	let lineNumber = 0;
	let includes = [];
	let attributes = [];
	let results = [];

	document.getElementById('fileInput').addEventListener('change', function(event) {
		const file = event.target.files[0];
		if (file) {
			let url = URL.createObjectURL(file);
			lineNumber = 0;
			includes = [];
			results = [];
			(async () => {
				document.getElementById("filefeedback").innerHTML = "Reading...";
				for await (let line of makeTextFileLineIterator(url)) {
					process(line);
				}
				showResults();
				document.getElementById("filefeedback").innerHTML = "Done processing";
			})();
		}
	});
	
	function showResults(){
		
		let outputElement = document.getElementById("output");
		while(outputElement.lastChild!= null){
			outputElement.removeChild(outputElement.lastChild);
		}
		
		for (let j = 0; j < results.length; j++) {

			let lineDiv = document.createElement("div");
			lineDiv.className = "line";
			let timeResults = results[j];
			for(let i = 0; i < timeResults.length; i++){			
				let valueDiv = document.createElement("div");
				valueDiv.className = "value";
				valueDiv.innerHTML = timeResults[i];
				lineDiv.appendChild(valueDiv);			
}
			outputElement.appendChild(lineDiv);
		}

		
	}

	async function* makeTextFileLineIterator(fileURL) {
		const utf8Decoder = new TextDecoder("utf-8");
		let response = await fetch(fileURL);
		let reader = response.body.getReader();
		let { value: chunk, done: readerDone } = await reader.read();
		chunk = chunk ? utf8Decoder.decode(chunk, { stream: true }) : "";

		let re = /\r\n|\n|\r/gm;
		let startIndex = 0;

		for (; ;) {
			let result = re.exec(chunk);
			if (!result) {
				if (readerDone) {
					break;
				}
				let remainder = chunk.substr(startIndex);
				({ value: chunk, done: readerDone } = await reader.read());
				chunk =
					remainder + (chunk ? utf8Decoder.decode(chunk, { stream: true }) : "");
				startIndex = re.lastIndex = 0;
				continue;
			}
			yield chunk.substring(startIndex, result.index);
			startIndex = re.lastIndex;
		}
		if (startIndex < chunk.length) {
			// last line didn't end in a newline char
			yield chunk.substr(startIndex);
		}
	}
	
	function processHeader(line) {
		
		let headers = line.split(';');
		let headerLine = [];
		for (let i = 0; i < headers.length; i++) {

			if(lineNumber == 0){			
				includes.push( i == 0 || predicate == null ? true : predicate(headers[i]));
			}
			if(includes[i]){
				headerLine.push(headers[i]);
			}
		}
		results.push(headerLine);
	}

	function process(line) {
		if (lineNumber <=1) {
			processHeader(line);
		} else {
			processDateLine(line,startDate, endDate);
		}
		lineNumber++;
	}
	
	function processDateLine(line) {

		var lines = [];

		var data = line.split(';');
		if (data.length > 0 ) {
			try {
				let date = new Date(data[0]);
				if (date < startDate || date > endDate) {
					return;
				}

			} catch (error) {
				console.log("Failed to init date for " + data[0]);
				return;
			}
		}
		let resultLine = [];
		for (let j = 0; j < data.length && j < includes.length; j++) {
			if (includes[j]) {
				resultLine.push(data[j]);
			}
		}
		results.push(resultLine);		

	}
	    
		
    </script>
</body>
</html>