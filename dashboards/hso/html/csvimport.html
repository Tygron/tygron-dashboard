<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Read CSV File</title>
<style>
.line {
	display: flex;
	flex-direction: row;
}

.value {
	margin-right: 5px;
	background: red;
	width: 150px;
}

.value:first-child {
	width: 200px;
}
</style>
</head>
<body>
	<input type="file" id="fileInput" accept=".csv" />
	<pre id="output"></pre>

	<script>
	let counter = 0;
	let includes = [];
	let headers = [];
	let attributes = [];
	let outputElement = document.getElementById("output");
	let startDate = new Date("2020-03-21");
	let endDate = new Date("2020-03-28");
	let predicate = function(s){ return s== null? false : s.startsWith("WS000278")};	 

	document.getElementById('fileInput').addEventListener('change', function(event) {
		const file = event.target.files[0];
		if (file) {
			let url = URL.createObjectURL(file);

			(async () => {
				console.log("Start url reading");
				for await (let line of makeTextFileLineIterator(url)) {
					process(line);
				}
				console.log("Done processing");
			})();
		}
	});

	async function* makeTextFileLineIterator(fileURL) {
		const utf8Decoder = new TextDecoder("utf-8");
		let response = await fetch(fileURL);
		let reader = response.body.getReader();
		let { value: chunk, done: readerDone } = await reader.read();
		chunk = chunk ? utf8Decoder.decode(chunk, { stream: true }) : "";

		let re = /\r\n|\n|\r/gm;
		let startIndex = 0;

		for (; ;) {
			let result = re.exec(chunk);
			if (!result) {
				if (readerDone) {
					break;
				}
				let remainder = chunk.substr(startIndex);
				({ value: chunk, done: readerDone } = await reader.read());
				chunk =
					remainder + (chunk ? utf8Decoder.decode(chunk, { stream: true }) : "");
				startIndex = re.lastIndex = 0;
				continue;
			}
			yield chunk.substring(startIndex, result.index);
			startIndex = re.lastIndex;
		}
		if (startIndex < chunk.length) {
			// last line didn't end in a newline char
			yield chunk.substr(startIndex);
		}
	}



	//TODO: Add date compare: new Data(text)
	function processHeader(line) {
		let include = [];
		let lineDiv = document.createElement("div");
		lineDiv.className = "line";
		outputElement.appendChild(lineDiv);
		var headers = line.split(';');
		for (let i = 0; i < headers.length; i++) {
			let incl = i == 0 || predicate == null ? true : predicate(headers[i]);
			include[i] = incl;

			if (incl) {
				let valueDiv = document.createElement("div");
				valueDiv.className = "value";
				valueDiv.innerHTML = headers[i];
				lineDiv.appendChild(valueDiv);
			}
		}
		return include;
	}

	function process(line) {
		if (counter == 0) {
			includes = processHeader(line);
		} else {
			processLine(includes, line);
		}
		counter++;
	}

	function processLine(include, line, minDate, maxDate) {

		var lines = [];

		var data = line.split(';');
		if (data.length > 0) {
			try {
				let date = new Date(data[0]);
				if (date < startDate || date > endDate) {
					return;
				}

			} catch (error) {
				console.log("Failed to init date for " + data[0]);
				return;
			}
		}
		const myDate = new Date()

		let lineDiv = document.createElement("div");
		lineDiv.className = "line";

		for (let j = 0; j < data.length && j < include.length; j++) {
			if (include[j]) {
				let valueDiv = document.createElement("div");
				valueDiv.className = "value";
				valueDiv.innerHTML = data[j];
				lineDiv.appendChild(valueDiv);
			}
		}

		outputElement.appendChild(lineDiv);

	}
	    
		
    </script>
</body>
</html>